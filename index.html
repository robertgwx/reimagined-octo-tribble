<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Atlantic Forecast Regions Wind Warnings</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { margin:0; font-family: 'Inter', sans-serif; }
  #map { height:100vh; width:100vw; }
  .leaflet-popup-content-wrapper { background-color:#fff; color:#333; border-radius:8px; }
  .tooltip { position:absolute; pointer-events:none; background:#fff; padding:4px 6px; border-radius:4px; border:1px solid #aaa; font-size:12px; opacity:0; }
</style>
</head>
<body>
<div id="map"></div>

<div class="absolute top-4 left-4 p-4 z-[1000]">
  <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 w-80">
    <h1 class="text-xl font-bold text-gray-800">Wind Warning Control</h1>
    <div class="mt-4 space-y-4">
      <div>
        <label for="sustained-wind-input" class="block text-sm font-medium text-gray-700">Sustained Wind (km/h)</label>
        <input type="number" id="sustained-wind-input" placeholder="e.g., 70" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
      </div>
      <div>
        <label for="gust-wind-input" class="block text-sm font-medium text-gray-700">Gust Wind (km/h)</label>
        <input type="number" id="gust-wind-input" placeholder="e.g., 100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
      </div>
    </div>
    <div class="mt-4 flex space-x-2">
      <button id="update-map-btn" class="flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Update Map</button>
      <button id="clear-map-btn" class="flex-1 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Clear</button>
    </div>
    <div id="debug-info" class="mt-4 text-xs text-gray-500 bg-gray-100 p-2 rounded">Initializing...</div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
const map = L.map('map').setView([50.5, -58], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19, attribution:'&copy; OpenStreetMap'
}).addTo(map);

// D3 overlay
const svgLayer = L.svg().addTo(map);
const svg = d3.select("#map").select("svg");
const g = svg.append("g").attr("class","d3-overlay");

// --- Config ---
const TIERS = {
  RED:    { name: 'RED', level: 3, color: '#dc2626', hatchColor: '#b91c1c' },
  ORANGE: { name: 'ORANGE', level: 2, color: '#f97316', hatchColor: '#ea580c' },
  YELLOW: { name: 'YELLOW', level: 1, color: '#facc15', hatchColor: '#eab308' },
  NONE:   { name: 'NONE', level: 0, color: 'transparent' }
};

const WARNING_CONFIG = {
  'Maritimes': { thresholds: { YELLOW: { sustained:70, gust:90 }, ORANGE:{sustained:90,gust:110}, RED:{sustained:110,gust:130} } },
  'Landlocked NB': { thresholds: { YELLOW: { sustained:70, gust:90 }, ORANGE:{sustained:80,gust:100}, RED:{sustained:90,gust:110} } },
  'Coastal NL': { thresholds: { YELLOW:{sustained:80,gust:100}, ORANGE:{sustained:110,gust:130}, RED:{sustained:130,gust:160} } },
  'Landlocked NF': { thresholds: { YELLOW:{sustained:70,gust:90}, ORANGE:{sustained:90,gust:110}, RED:{sustained:110,gust:130} } },
  'Landlocked Labrador': { thresholds: { YELLOW:{sustained:70,gust:90}, ORANGE:{sustained:80,gust:100}, RED:{sustained:90,gust:110} } },
  'Downslope NL': { parentCategory:'Coastal NL', thresholds:{ YELLOW:{sustained:80,gust:100}, ORANGE:{sustained:110,gust:140}, RED:{sustained:140,gust:180} } },
  'Wreckhouse': { parentCategory:'Coastal NL', thresholds:{ YELLOW:{sustained:80,gust:100}, ORANGE:{sustained:110,gust:140}, RED:{sustained:140,gust:180} } },
  'Les Suetes': { parentCategory:'Maritimes', thresholds:{ YELLOW:{sustained:70,gust:90}, ORANGE:{sustained:110,gust:140}, RED:{sustained:140,gust:180} } }
};

const REGION_CATEGORIES = {
  'Maritimes': ["4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","25","26","31","37","33","36","38","39","44","45","46","47","48","49"],
  'Landlocked NB': ["27","28","29","30","32","34","35","40","41","42","43"],
  'Coastal NL': ["50","51","52","53","54","55","56","64","65","66","67","69","70","71","74","75","76","77","78","79","80"],
  'Landlocked NF': ["59","62","63","68"], 
  'Landlocked Labrador': ["81","82","83","84","85"],
  'Downslope NL': ["58","60","61","72","73"], 
  'Wreckhouse': ["57"], 
  'Les Suetes': ["24"]
};

const FID_TO_CATEGORY_MAP = {};
for(const cat in REGION_CATEGORIES){
  REGION_CATEGORIES[cat].forEach(fidNum => FID_TO_CATEGORY_MAP[`land_standard_coarse.${fidNum}`]=cat);
}

let polygonsData = []; // store parsed GML features

// --- Tooltip ---
const tooltip = d3.select("#tooltip");

// --- Parse GML ---
function parseGML(gmlText){
  const parser = new DOMParser();
  const xml = parser.parseFromString(gmlText,"application/xml");
  const members = xml.querySelectorAll("gml\\:featureMember, featureMember");
  polygonsData = [];
  members.forEach(member=>{
    const fid = member.firstElementChild.getAttribute("fid");
    const name = member.querySelector("ogr\\:NAME, NAME")?.textContent || fid;
    const category = FID_TO_CATEGORY_MAP[fid] || "Maritimes";
    const coordTags = member.querySelectorAll("gml\\:coordinates, coordinates");
    const coordsList = [];
    coordTags.forEach(tag=>{
      const coords = tag.textContent.trim().split(/\s+/).map(c=>{
        const [lon,lat] = c.split(",").map(parseFloat);
        return [lat,lon];
      }).filter(Boolean);
      if(coords.length>3) coordsList.push(coords);
    });
    if(coordsList.length>0){
      polygonsData.push({fid,name,category,coordsList});
    }
  });
}

// --- Draw polygons with D3 on Leaflet ---
function drawMap(sustained=0,gust=0){
  g.selectAll("*").remove();
  const transform = d3.geoTransform({
    point: function(x,y){
      const p = map.latLngToLayerPoint(new L.LatLng(y,x));
      this.stream.point(p.x,p.y);
    }
  });
  const pathGen = d3.geoPath().projection(transform);

  polygonsData.forEach(d=>{
    const cfg = WARNING_CONFIG[d.category];
    const isSpecial = "parentCategory" in cfg;
    const parentCat = isSpecial ? cfg.parentCategory : d.category;

    const parentT = (() => {
      const t = WARNING_CONFIG[parentCat].thresholds;
      if(sustained>=t.RED.sustained || gust>=t.RED.gust) return TIERS.RED;
      else if(sustained>=t.ORANGE.sustained || gust>=t.ORANGE.gust) return TIERS.ORANGE;
      else if(sustained>=t.YELLOW.sustained || gust>=t.YELLOW.gust) return TIERS.YELLOW;
      return TIERS.NONE;
    })();

    const specialT = (() => {
      if(!isSpecial) return TIERS.NONE;
      const t = cfg.thresholds;
      if(sustained>=t.RED.sustained || gust>=t.RED.gust) return TIERS.RED;
      else if(sustained>=t.ORANGE.sustained || gust>=t.ORANGE.gust) return TIERS.ORANGE;
      else if(sustained>=t.YELLOW.sustained || gust>=t.YELLOW.gust) return TIERS.YELLOW;
      return TIERS.NONE;
    })();

    const shouldHatch = specialT.level > 0;

    d.coordsList.forEach(polygon=>{
      const geo = {type:"Polygon",coordinates:[polygon.map(([lat,lon])=>[lon,lat])]};
      const pathD = pathGen(geo);

      // --- Parent fill ---
      g.append("path")
        .attr("d", pathD)
        .attr("fill", parentT.color)
        .attr("fill-opacity",0.4)
        .attr("stroke","black")
        .attr("stroke-width",1)
        .on("mousemove", event => {
          // Determine applied tier and thresholds
          let tierName = "NONE";
          let thresholdsText = "";

          if (specialT.level > 0) {
            tierName = specialT.name;
            const t = cfg.thresholds[tierName];
            thresholdsText = `Sustained ≥ ${t.sustained} km/h, Gust ≥ ${t.gust} km/h`;
          } else if (parentT.level > 0) {
            tierName = parentT.name;
            const t = WARNING_CONFIG[d.category].thresholds[tierName];
            thresholdsText = `Sustained ≥ ${t.sustained} km/h, Gust ≥ ${t.gust} km/h`;
          }

          tooltip
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY + 10) + "px")
            .style("opacity", 1)
            .html(`<b>${d.name}</b><br>Tier: ${tierName}<br>${thresholdsText}`);
        })
        .on("mouseout", () => tooltip.style("opacity",0));

      // --- Hatch overlay ---
      if(shouldHatch){
        g.append("path")
          .attr("d", pathD)
          .attr("fill","url(#hatch-" + specialT.name + ")")
          .attr("fill-opacity",1.0)
          .attr("stroke","none");
      }
    });
  });
}

// --- Create hatch patterns with neon colors ---
const defs = svg.append("defs");
const hatchSize = 20;
const lineThickness = 8;

const hatchTiers = [
  { name: "YELLOW", color: "#FFFF00" },
  { name: "ORANGE", color: "#FF9500" },
  { name: "RED",    color: "#FF3333" }
];

hatchTiers.forEach(tier => {
  const pattern = defs.append("pattern")
    .attr("id","hatch-" + tier.name)
    .attr("patternUnits","userSpaceOnUse")
    .attr("width", hatchSize)
    .attr("height", hatchSize)
    .attr("patternTransform","rotate(45)");

  pattern.append("line")
    .attr("x1",0).attr("y1",0)
    .attr("x2", hatchSize).attr("y2",0)
    .attr("stroke", tier.color)
    .attr("stroke-width", lineThickness)
    .attr("stroke-linecap","butt");
});

// --- Load GML ---
async function loadGML(){
  try{
    const resp = await fetch("land_standard_exaggerated_atlantic.gml");
    const text = await resp.text();
    parseGML(text);
    drawMap();
    d3.select("#debug-info").text(`Loaded ${polygonsData.length} regions.`);
  }catch(e){ console.error(e); }
}

map.on("zoomend moveend",()=>drawMap(
  parseFloat(document.getElementById("sustained-wind-input").value)||0,
  parseFloat(document.getElementById("gust-wind-input").value)||0
));

document.getElementById("update-map-btn").addEventListener("click",()=>drawMap(
  parseFloat(document.getElementById("sustained-wind-input").value)||0,
  parseFloat(document.getElementById("gust-wind-input").value)||0
));
document.getElementById("clear-map-btn").addEventListener("click",()=>{
  document.getElementById("sustained-wind-input").value="";
  document.getElementById("gust-wind-input").value="";
  drawMap();
});

loadGML();
</script>
</body>
</html>
