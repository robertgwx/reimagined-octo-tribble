<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wind Warning Reference - Atlantic</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family: 'Inter', sans-serif; }
  #map { height:100vh; width:100vw; }
  .leaflet-popup-content-wrapper { background-color:#fff; color:#333; border-radius:8px; }
  .tooltip {
    position:absolute;
    pointer-events:none;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 13px;
    line-height: 1.5;
    opacity: 0;
    z-index: 1100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: opacity 0.2s ease-in-out;
    max-width: 300px;
  }
  .tooltip hr {
    border: none;
    border-top: 1px solid #ddd;
    margin: 6px 0;
  }
  .tooltip-tier { font-weight: bold; }
  .tooltip-tier.yellow { color: #dbbd10; }
  .tooltip-tier.orange { color: #ff5900; }
  .tooltip-tier.red { color: #ff0000; }
  .draggable-handle {
    cursor: move;
    height: 16px;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    padding-top: 4px;
  }
  .draggable-grip {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 24px;
    height: 12px;
    justify-content: space-between;
    padding: 4px 0;
  }
  .draggable-grip-line {
    height: 2px;
    width: 100%;
    background-color: #d1d5db; /* Light gray */
    border-radius: 9999px;
  }
  .collapsible-content {
    max-height: 500px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
  }
  .collapsible-content.collapsed {
    max-height: 0;
  }
  .loader-spinner {
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  .loader-hidden {
    opacity: 0;
    pointer-events: none;
  }
  
  /* Added for loader animations */
  .loader-pop-up {
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
  }
  
  @keyframes pop-in {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
  }
  
  @keyframes pop-out {
      from { transform: scale(1); opacity: 1; }
      to { transform: scale(0.9); opacity: 0; }
  }
  
  .animate-pop-in {
      animation: pop-in 0.3s forwards;
  }
  
  .animate-pop-out {
      animation: pop-out 0.3s forwards;
  }
</style>
</head>
<body>
<!-- Loading Indicator and Error Popup -->
<div id="loader" class="fixed inset-0 z-[2000] flex items-center justify-center bg-white/30 backdrop-blur-sm transition-opacity duration-500 ease-in-out">
  <div id="loading-pop-up" class="loader-pop-up bg-white/50" style="display: flex;">
    <div id="loading-spinner" class="loader-spinner h-12 w-12 rounded-full border-4 border-solid border-blue-500 border-t-transparent animate-spin"></div>
    <p id="loading-text" class="mt-4 text-gray-700 font-semibold">Loading Map...</p>
  </div>
  
  <div id="error-message" class="loader-pop-up bg-red-100/70 border-2 border-red-600 text-red-800">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="mt-4 font-bold text-lg text-center">Map Failed to Load</p>
      <p class="mt-2 text-sm text-center text-red-800">There was an issue loading the region shapefile. Please try again later.</p>
      <button id="close-error-btn" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Dismiss</button>
  </div>
  
  <div id="success-message" class="loader-pop-up bg-green-100/50 border-2 border-green-600">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <p class="mt-4 font-bold text-lg text-gray-700">Map Loaded Successfully!</p>
  </div>
</div>

<div id="map"></div>

<!-- Wind Warning Reference Panel -->
<div id="control-panel" class="absolute top-4 left-4 z-[1000] rounded-xl shadow-lg w-[20rem] bg-white/80 backdrop-blur-sm p-6">
  <div class="draggable-handle">
    <div class="draggable-grip">
        <div class="draggable-grip-line"></div>
        <div class="draggable-grip-line"></div>
        <div class="draggable-grip-line"></div>
    </div>
  </div>
  <h1 class="text-xl font-bold text-gray-800">Wind Warning Reference</h1>
  <div class="mt-4 flex space-x-4">
    <div class="flex-1">
      <label for="sustained-wind-input" id="sustained-label" class="block text-sm font-medium text-gray-700">Sustained (km/h)</label>
      <input type="number" id="sustained-wind-input" placeholder="e.g., 70" step="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
    </div>
    <div class="flex-1">
      <label for="gust-wind-input" id="gust-label" class="block text-sm font-medium text-gray-700">Gust (km/h)</label>
      <input type="number" id="gust-wind-input" placeholder="e.g., 100" step="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
    </div>
  </div>
  
  <div class="mt-4">
      <label for="localized-gusts-select" class="block text-sm font-medium text-gray-700">SCRIBE Exception</label>
      <select id="localized-gusts-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
          <option value="none">(none)</option>
          <option value="exposed-areas">over exposed areas</option>
          <option value="exposed-coast">along exposed areas of the coast</option>
          <option value="parts-coast">along parts of the coast</option>
          <option value="the-coast">along the coast</option>
          <option value="downslope-NL">along the coast in locally enhanced downslope flow</option>
          <option value="wreckhouse">in the Wreckhouse area</option>
          <option value="les-suetes">from Margaree Harbour to Bay St. Lawrence</option>
      </select>
  </div>

  <!-- Wind Warning Map Legend -->
  <div class="mt-4 pt-4 border-t border-gray-200">
    <h2 class="text-lg font-bold text-gray-800">Map Legend</h2>
    <ul class="mt-4 space-y-2 mb-6">
      <li class="flex items-center space-x-2">
        <div class="w-6 h-6 rounded-md bg-transparent border-2 border-gray-300"></div>
        <span class="text-gray-700">No Warning</span>
      </li>
      <li class="flex items-center space-x-2">
        <div class="w-6 h-6 rounded-md bg-yellow-400 opacity-40"></div>
        <span class="text-gray-700">Yellow Warning</span>
      </li>
      <li class="flex items-center space-x-2">
        <div class="w-6 h-6 rounded-md bg-orange-500 opacity-40"></div>
        <span class="text-gray-700">Orange Warning</span>
      </li>
      <li class="flex items-center space-x-2">
        <div class="w-6 h-6 rounded-md bg-red-600 opacity-40"></div>
        <span class="text-gray-700">Red Warning</span>
      </li>
    </ul>
  </div>
  
  <!-- Instructions Panel (Collapsible) -->
  <div class="mt-4 pt-4 border-t border-gray-200">
    <div class="flex justify-between items-center cursor-pointer" id="instructions-header">
      <h2 class="text-lg font-bold text-gray-800">How to Use</h2>
      <button class="text-gray-500 hover:text-gray-800 focus:outline-none" id="instructions-toggle-btn">
        <svg id="chevron-right" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
        <svg id="chevron-down" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 hidden">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
        </svg>
      </button>
    </div>
    <div id="instructions-content" class="collapsible-content collapsed mt-4">
      <ul class="space-y-2 text-sm text-gray-700">
        <li>1. Enter forecasted sustained, gust, or sustained and gust speeds.</li>
        <li>2. Select a SCRIBE exception, if applicable.</li>
        <li>3. The map will automatically update with the corresponding warning tiers.</li>
        <li>4. Hover over a region to see the warning criteria and other important information.</li>
      </ul>
      <div class="pt-2 border-t border-gray-200 text-center text-xs text-gray-500 mt-4">
        <span>v1.1.0</span><br>
      </div>
    </div>
  </div>
</div>

<!-- Link to other warning types -->
<a href="precip_warning_reference.html" class="fixed bottom-4 left-4 z-[1000] bg-gray-100 text-gray-800 rounded-lg shadow-md p-2 border border-gray-300 transition-all duration-300 ease-in-out hover:bg-gray-200 hover:shadow-xl hover:shadow-gray-400/50">
    <span class="text-base">üíß‚ùÑÔ∏è Precipitation Warnings</span>
</a>

<div class="tooltip" id="tooltip"></div>

<script>
const map = L.map('map', { zoomControl: false }).setView([50.5, -58], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19, attribution:'&copy; OpenStreetMap'
}).addTo(map);

L.control.zoom({ position: 'topright' }).addTo(map);

// D3 overlay
const svgLayer = L.svg().addTo(map);
const svg = d3.select("#map").select("svg");
const g = svg.append("g").attr("class","d3-overlay");

// --- Config ---
const TIERS = {
  RED:    { name: 'RED', level: 3, color: '#dc2626' },
  ORANGE: { name: 'ORANGE', level: 2, color: '#f97316' },
  YELLOW: { name: 'YELLOW', level: 1, color: '#facc15' },
  NONE:   { name: 'NONE', level: 0, color: 'transparent' }
};

const WARNING_CONFIG = {
  'Maritimes': { thresholds: { YELLOW: { sustained:70, gust:90 }, ORANGE:{sustained:90,gust:110}, RED:{sustained:110,gust:130} } },
  'Landlocked NB': { thresholds: { YELLOW: { sustained:70, gust:90 }, ORANGE:{sustained:80,gust:100}, RED:{sustained:90,gust:110} } },
  'Coastal NL': { thresholds: { YELLOW:{sustained:80,gust:100}, ORANGE:{sustained:110,gust:130}, RED:{sustained:130,gust:160} } },
  'Landlocked NF': { thresholds: { YELLOW:{sustained:70,gust:90}, ORANGE:{sustained:90,gust:110}, RED:{sustained:110,gust:130} } },
  'Landlocked Labrador': { thresholds: { YELLOW:{sustained:70,gust:90}, ORANGE:{sustained:80,gust:100}, RED:{sustained:90,gust:110} } },
  'Downslope NL': { parentCategory:'Coastal NL', thresholds:{ YELLOW:{sustained:80,gust:100}, ORANGE:{sustained:110,gust:140}, RED:{sustained:140,gust:180} } },
  'Wreckhouse': { parentCategory:'Coastal NL', thresholds:{ YELLOW:{sustained:80,gust:100}, ORANGE:{sustained:110,gust:140}, RED:{sustained:140,gust:180} } },
  'Les Suetes': { parentCategory:'Maritimes', thresholds:{ YELLOW:{sustained:70,gust:90}, ORANGE:{sustained:110,gust:140}, RED:{sustained:140,gust:180} } }
};

const REGION_CATEGORIES = {
  'Maritimes': ["4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","25","26","31","37","33","36","38","39","44","45","46","47","48","49"],
  'Landlocked NB': ["27","28","29","30","32","34","35","40","41","42","43"],
  'Coastal NL': ["50","51","52","53","54","55","56","64","65","66","67","69","70","71","74","75","76","77","78","79","80"],
  'Landlocked NF': ["59","62","63","68"],
  'Landlocked Labrador': ["81","82","83","84","85"],
  'Downslope NL': ["58","60","61","72","73"],
  'Wreckhouse': ["57"],
  'Les Suetes': ["24"]
};

const FID_TO_CATEGORY_MAP = {};
for(const cat in REGION_CATEGORIES){
  REGION_CATEGORIES[cat].forEach(fidNum => FID_TO_CATEGORY_MAP[`land_standard_coarse.${fidNum}`]=cat);
}

// Map special category names to their exception values
const categoryToException = {
    'Wreckhouse': 'wreckhouse',
    'Les Suetes': 'les-suetes',
    'Downslope NL': 'downslope-NL'
};

let polygonsData = [];

const tooltip = d3.select("#tooltip");

function parseGML(gmlText){
  const parser = new DOMParser();
  const xml = parser.parseFromString(gmlText,"application/xml");
  const members = xml.querySelectorAll("gml\\:featureMember, featureMember");
  polygonsData = [];
  members.forEach(member=>{
    const fid = member.firstElementChild.getAttribute("fid");
    const name = member.querySelector("ogr\\:NAME, NAME")?.textContent || fid;
    const category = FID_TO_CATEGORY_MAP[fid] || "Maritimes";
    const coordTags = member.querySelectorAll("gml\\:coordinates, coordinates");
    const coordsList = [];
    coordTags.forEach(tag=>{
      const coords = tag.textContent.trim().split(/\s+/).map(c=>{
        const [lon,lat] = c.split(",").map(parseFloat);
        return [lat,lon];
      }).filter(Boolean);
      if(coords.length>3) coordsList.push(coords);
    });
    if(coordsList.length>0){
      polygonsData.push({fid,name,category,coordsList});
    }
  });
}

function drawMap(sustained, gust){
  g.selectAll("*").remove();
  const transform = d3.geoTransform({
    point: function(x,y){
      const p = map.latLngToLayerPoint(new L.LatLng(y,x));
      this.stream.point(p.x,p.y);
    }
  });
  const pathGen = d3.geoPath().projection(transform);
  const localizedGustsSelect = document.getElementById("localized-gusts-select");
  const selectedException = localizedGustsSelect.value;
  const selectedOptionText = localizedGustsSelect.options[localizedGustsSelect.selectedIndex].text;

  polygonsData.forEach(d=>{
    const cfg = WARNING_CONFIG[d.category];
    const isSpecial = "parentCategory" in cfg;
    const parentCat = isSpecial ? cfg.parentCategory : d.category;
    const parentConfig = WARNING_CONFIG[parentCat];
    
    // Determine the tier based on sustained/gust for a given config
    const getTier = (config) => {
      const t = config.thresholds;
      if (sustained >= t.RED.sustained || gust >= t.RED.gust) return TIERS.RED;
      if (sustained >= t.ORANGE.sustained || gust >= t.ORANGE.gust) return TIERS.ORANGE;
      if (sustained >= t.YELLOW.sustained || gust >= t.YELLOW.gust) return TIERS.YELLOW;
      return TIERS.NONE;
    };
    
    let fillTier = TIERS.NONE;
    let tooltipNote = '';
    
    // Logic for coloring based on the dropdown selection
    switch(selectedException) {
      case 'wreckhouse':
        if (d.category === 'Wreckhouse') {
          fillTier = getTier(cfg);
        } else {
          fillTier = TIERS.NONE;
        }
        break;
      case 'downslope-NL':
        if (d.category === 'Downslope NL') {
          fillTier = getTier(cfg);
        } else {
          fillTier = TIERS.NONE;
        }
        break;
      case 'les-suetes':
        if (d.category === 'Les Suetes') {
          fillTier = getTier(cfg);
        } else {
          fillTier = TIERS.NONE;
        }
        break;
      case 'exposed-areas':
        // This handles localized gusts for Landlocked NL
        if (d.category.includes('Landlocked')) {
            if (d.category === 'Landlocked NF') {
                if (gust === 90) {
                     fillTier = TIERS.NONE;
                     tooltipNote = '"Over exposed areas" exception used - therefore no warning is necessary. Use your discretion.';
                } else if (gust === 110) {
                     fillTier = TIERS.YELLOW;
                     tooltipNote = '"Over exposed areas" exception used - issue a <span class="tooltip-tier yellow">YELLOW</span> warning.';
                } else if (gust === 130) {
                     fillTier = TIERS.ORANGE;
                     tooltipNote = '"Over exposed areas" exception used - issue an <span class="tooltip-tier orange">ORANGE</span> warning.';
                } else {
                     fillTier = getTier(parentConfig);
                }
            } else if (d.category === 'Landlocked Labrador') {
                if (gust === 100) {
                     fillTier = TIERS.YELLOW;
                     tooltipNote = '"Over exposed areas" exception used - issue a <span class="tooltip-tier yellow">YELLOW</span> warning.';
                } else if (gust === 110) {
                     fillTier = TIERS.ORANGE;
                     tooltipNote = '"Over exposed areas" exception used - issue an <span class="tooltip-tier orange">ORANGE</span> warning.';
                } else {
                     fillTier = getTier(parentConfig);
                }
            } else {
                 fillTier = getTier(parentConfig);
            }
        } else {
            fillTier = getTier(parentConfig);
        }
        break;
      case 'exposed-coast':
        if (d.category.includes('Landlocked')) {
            fillTier = TIERS.NONE;
            tooltipNote = "No Coastal Areas - No Warning";
        } else if (parentCat === 'Maritimes' || d.category === 'Maritimes') {
            if (gust === 110) {
                 fillTier = TIERS.YELLOW;
                 tooltipNote = '"Along exposed areas of the coast" exception used - issue a <span class="tooltip-tier yellow">YELLOW</span> warning.';
            } else if (gust === 130 || gust === 140) {
                 fillTier = TIERS.ORANGE;
                 tooltipNote = '"Along exposed areas of the coast" exception used - issue an <span class="tooltip-tier orange">ORANGE</span> warning.';
            } else {
                 fillTier = getTier(parentConfig);
            }
        } else {
            fillTier = getTier(parentConfig);
        }
        break;
      case 'parts-coast':
      case 'the-coast':
        if (d.category.includes('Landlocked')) {
            fillTier = TIERS.NONE;
            tooltipNote = "No Coastal Areas - No Warning";
        } else {
            fillTier = getTier(parentConfig);
        }
        break;
      default:
        // Default behavior (no exception selected)
        const specialTier = isSpecial ? getTier(cfg) : TIERS.NONE;
        const parentTier = getTier(parentConfig);
        fillTier = parentTier.level > specialTier.level ? parentTier : specialTier;
        break;
    }

    // Add a note for special regions. This only displays if the region has a warning.
    if (isSpecial) {
        if (selectedException === categoryToException[d.category]) {
            tooltipNote = `<b><u>NOTE:</u></b> The displayed tier is for <b>${d.category} only</b>.`;
        } else if (selectedException === 'none' && fillTier.level > 0) {
            tooltipNote = `<b><u>NOTE:</u></b> The displayed tier is for main condition winds. If you want to see the tier for <b>${d.category}</b>, select the appropriate SCRIBE exception.`;
        }
    }

    d.coordsList.forEach(polygon=>{
      const geo = {type:"Polygon",coordinates:[polygon.map(([lat,lon])=>[lon,lat])]};
      const pathD = pathGen(geo);

      g.append("path")
        .attr("d", pathD)
        .attr("fill", fillTier.color)
        .attr("fill-opacity", fillTier.level > 0 ? 0.4 : 0)
        .attr("stroke", "black")
        .attr("stroke-width", 1)
        .style("pointer-events", "all")
        .on("mousemove", event => {
          let tierName = fillTier.name;
          let tooltipHtml = `<b>${d.name}</b><hr>`;
          
          if (tierName !== 'NONE') {
              let tooltipConfig = parentConfig;
              if (isSpecial && selectedException === categoryToException[d.category]) {
                tooltipConfig = cfg;
              } else if (isSpecial && selectedException === 'none') {
                const specialTier = getTier(cfg);
                const parentTier = getTier(parentConfig);
                if (specialTier.level > parentTier.level) {
                  tooltipConfig = cfg;
                }
              }
              
              const t = tooltipConfig.thresholds[tierName];
              let thresholdsText = "";
              let sustainedValue = t.sustained;
              let gustValue = t.gust;
              
              if (t) {
                  thresholdsText = `Sustained ‚â• ${sustainedValue}, Gust ‚â• ${gustValue} km/h`;
              }
              tooltipHtml += `Tier: <span class="tooltip-tier ${tierName.toLowerCase()}">${tierName}</span><br><span class="text-xs">${thresholdsText}</span>`;
          } else {
            tooltipHtml += 'Warning Criteria Not Met';
          }
          
          if (tooltipNote) {
             tooltipHtml += `<hr><div class="text-xs italic text-gray-600">${tooltipNote}</div>`;
          }

          tooltip
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY + 10) + "px")
            .style("opacity", 1)
            .html(tooltipHtml);
        })
        .on("mouseout", () => tooltip.style("opacity",0));
    });
  });
}

function animateAndHidePopup(element) {
    element.classList.remove('animate-pop-in');
    element.classList.add('animate-pop-out');
    setTimeout(() => {
        element.style.display = 'none';
        const loader = document.getElementById('loader');
        loader.classList.add('loader-hidden');
        setTimeout(() => loader.style.display = 'none', 500);
    }, 300); // Match animation duration
}

function showError() {
    const loadingPopUp = document.getElementById('loading-pop-up');
    const errorMessage = document.getElementById('error-message');
    
    loadingPopUp.style.display = 'none';
    errorMessage.style.display = 'flex';
    errorMessage.classList.add('animate-pop-in');
}

function showSuccess() {
    const loadingPopUp = document.getElementById('loading-pop-up');
    const successMessage = document.getElementById('success-message');
    
    loadingPopUp.style.display = 'none';
    successMessage.style.display = 'flex';
    successMessage.classList.add('animate-pop-in');
    
    setTimeout(() => {
        animateAndHidePopup(successMessage);
    }, 500);
}

async function loadGML(){
  try{
    const resp = await fetch("land_standard_exaggerated_atlantic.gml");
    if (!resp.ok) {
        throw new Error(`Failed to fetch GML file: ${resp.statusText}`);
    }
    const text = await resp.text();
    parseGML(text);
    updateMap();
    showSuccess();
  }catch(e){ 
    console.error(e);
    showError();
  }
}

function updateMap() {
    const sustainedKmH = parseFloat(sustainedInput.value) || 0;
    const gustKmH = parseFloat(gustInput.value) || 0;
    drawMap(sustainedKmH, gustKmH);
}

map.on("zoomend moveend", updateMap);

const sustainedInput = document.getElementById("sustained-wind-input");
const gustInput = document.getElementById("gust-wind-input");
const localizedGustsSelect = document.getElementById("localized-gusts-select");

sustainedInput.addEventListener("input", updateMap);
gustInput.addEventListener("input", updateMap);
localizedGustsSelect.addEventListener("change", updateMap);

loadGML();

function makeDraggable(elementId) {
  const element = document.getElementById(elementId);
  const handle = element.querySelector('.draggable-handle');

  let isDragging = false;
  let offsetX, offsetY;

  handle.addEventListener('mousedown', (e) => {
    isDragging = true;
    offsetX = e.clientX - element.offsetLeft;
    offsetY = e.clientY - element.offsetTop;
    e.preventDefault();
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    element.style.left = `${e.clientX - offsetX}px`;
    element.style.top = `${e.clientY - offsetY}px`;
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
  });
}

makeDraggable('control-panel');

const instructionsHeader = document.getElementById('instructions-header');
const instructionsContent = document.getElementById('instructions-content');
const chevronRight = document.getElementById('chevron-right');
const chevronDown = document.getElementById('chevron-down');
const closeErrorBtn = document.getElementById('close-error-btn');

instructionsHeader.addEventListener('click', () => {
  const isCollapsed = instructionsContent.classList.toggle('collapsed');
  chevronRight.classList.toggle('hidden', !isCollapsed);
  chevronDown.classList.toggle('hidden', isCollapsed);
});

closeErrorBtn.addEventListener('click', () => {
    animateAndHidePopup(document.getElementById('error-message'));
});
</script>
</body>
</html>
