<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Atlantic Forecast Regions Wind Warnings</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { margin:0; font-family: 'Inter', sans-serif; }
  #map { height:100vh; width:100vw; }
  .leaflet-popup-content-wrapper { background-color:#fff; color:#333; border-radius:8px; }
  .tooltip {
    position:absolute;
    pointer-events:none;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 13px;
    line-height: 1.5;
    opacity: 0;
    z-index: 1100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: opacity 0.2s ease-in-out;
    max-width: 300px;
  }
  .tooltip hr {
    border: none;
    border-top: 1px solid #ddd;
    margin: 6px 0;
  }
  .tooltip-tier { font-weight: bold; }
  .tooltip-tier.yellow { color: #dbbd10; }
  .tooltip-tier.orange { color: #ff5900; }
  .tooltip-tier.red { color: #ff0000; }
</style>
</head>
<body>
<div id="map"></div>

<!-- Wind Warning Reference Panel -->
<div class="absolute top-4 left-4 p-4 z-[1000]">
  <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 w-80">
    <h1 class="text-xl font-bold text-gray-800">Wind Warning Reference</h1>
    <div class="mt-4 flex space-x-4">
      <div class="flex-1">
        <label for="sustained-wind-input" class="block text-sm font-medium text-gray-700">Sustained (km/h)</label>
        <input type="number" id="sustained-wind-input" placeholder="e.g., 70" step="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
      </div>
      <div class="flex-1">
        <label for="gust-wind-input" class="block text-sm font-medium text-gray-700">Gust (km/h)</label>
        <input type="number" id="gust-wind-input" placeholder="e.g., 100" step="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
      </div>
    </div>
    
    <div class="mt-4">
        <label for="localized-gusts-select" class="block text-sm font-medium text-gray-700">SCRIBE Exception</label>
        <select id="localized-gusts-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            <option value="none">None</option>
            <option value="exposed-areas">over exposed areas</option>
            <option value="exposed-coast">along exposed areas of the coast</option>
            <option value="parts-coast">along parts of the coast</option>
            <option value="the-coast">along the coast</option>
            <option value="downslope-flow">along the coast in locally enhanced downslope flow</option>
            <option value="wreckhouse">in the Wreckhouse area</option>
            <option value="les-suetes">from Margaree Harbour to Bay St. Lawrence</option>
        </select>
    </div>

    <!-- Wind Warning Map Legend -->
    <div class="mt-6 pt-6 border-t border-gray-200">
      <h2 class="text-lg font-bold text-gray-800">Map Legend</h2>
      <ul class="mt-4 space-y-2">
        <li class="flex items-center space-x-2">
          <div class="w-6 h-6 rounded-md bg-transparent border-2 border-gray-300"></div>
          <span class="text-gray-700">No Warning</span>
        </li>
        <li class="flex items-center space-x-2">
          <div class="w-6 h-6 rounded-md bg-yellow-400 opacity-40"></div>
          <span class="text-gray-700">Yellow Warning</span>
        </li>
        <li class="flex items-center space-x-2">
          <div class="w-6 h-6 rounded-md bg-orange-500 opacity-40"></div>
          <span class="text-gray-700">Orange Warning</span>
        </li>
        <li class="flex items-center space-x-2">
          <div class="w-6 h-6 rounded-md bg-red-600 opacity-40"></div>
          <span class="text-gray-700">Red Warning</span>
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- Link to other warning types -->
<div class="absolute bottom-4 left-4 p-4 z-[1000]">
  <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-4">
    <a href="rainfall_warnings.html" class="block w-full text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
      View Rainfall & Snowfall Warnings
    </a>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
const map = L.map('map').setView([50.5, -58], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19, attribution:'&copy; OpenStreetMap'
}).addTo(map);

// D3 overlay
const svgLayer = L.svg().addTo(map);
const svg = d3.select("#map").select("svg");
const g = svg.append("g").attr("class","d3-overlay");

// --- Config ---
const TIERS = {
  RED:    { name: 'RED', level: 3, color: '#dc2626' },
  ORANGE: { name: 'ORANGE', level: 2, color: '#f97316' },
  YELLOW: { name: 'YELLOW', level: 1, color: '#facc15' },
  NONE:   { name: 'NONE', level: 0, color: 'transparent' }
};

const WARNING_CONFIG = {
  'Maritimes': { thresholds: { YELLOW: { sustained:70, gust:90 }, ORANGE:{sustained:90,gust:110}, RED:{sustained:110,gust:130} } },
  'Landlocked NB': { thresholds: { YELLOW: { sustained:70, gust:90 }, ORANGE:{sustained:80,gust:100}, RED:{sustained:90,gust:110} } },
  'Coastal NL': { thresholds: { YELLOW:{sustained:80,gust:100}, ORANGE:{sustained:110,gust:130}, RED:{sustained:130,gust:160} } },
  'Landlocked NF': { thresholds: { YELLOW:{sustained:70,gust:90}, ORANGE:{sustained:90,gust:110}, RED:{sustained:110,gust:130} } },
  'Landlocked Labrador': { thresholds: { YELLOW:{sustained:70,gust:90}, ORANGE:{sustained:80,gust:100}, RED:{sustained:90,gust:110} } },
  'Downslope NL': { parentCategory:'Coastal NL', thresholds:{ YELLOW:{sustained:80,gust:100}, ORANGE:{sustained:110,gust:140}, RED:{sustained:140,gust:180} } },
  'Wreckhouse': { parentCategory:'Coastal NL', thresholds:{ YELLOW:{sustained:80,gust:100}, ORANGE:{sustained:110,gust:140}, RED:{sustained:140,gust:180} } },
  'Les Suetes': { parentCategory:'Maritimes', thresholds:{ YELLOW:{sustained:70,gust:90}, ORANGE:{sustained:110,gust:140}, RED:{sustained:140,gust:180} } }
};

const REGION_CATEGORIES = {
  'Maritimes': ["4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","25","26","31","37","33","36","38","39","44","45","46","47","48","49"],
  'Landlocked NB': ["27","28","29","30","32","34","35","40","41","42","43"],
  'Coastal NL': ["50","51","52","53","54","55","56","64","65","66","67","69","70","71","74","75","76","77","78","79","80"],
  'Landlocked NF': ["59","62","63","68"],
  'Landlocked Labrador': ["81","82","83","84","85"],
  'Downslope NL': ["58","60","61","72","73"],
  'Wreckhouse': ["57"],
  'Les Suetes': ["24"]
};

const FID_TO_CATEGORY_MAP = {};
for(const cat in REGION_CATEGORIES){
  REGION_CATEGORIES[cat].forEach(fidNum => FID_TO_CATEGORY_MAP[`land_standard_coarse.${fidNum}`]=cat);
}

let polygonsData = [];

const tooltip = d3.select("#tooltip");

function parseGML(gmlText){
  const parser = new DOMParser();
  const xml = parser.parseFromString(gmlText,"application/xml");
  const members = xml.querySelectorAll("gml\\:featureMember, featureMember");
  polygonsData = [];
  members.forEach(member=>{
    const fid = member.firstElementChild.getAttribute("fid");
    const name = member.querySelector("ogr\\:NAME, NAME")?.textContent || fid;
    const category = FID_TO_CATEGORY_MAP[fid] || "Maritimes";
    const coordTags = member.querySelectorAll("gml\\:coordinates, coordinates");
    const coordsList = [];
    coordTags.forEach(tag=>{
      const coords = tag.textContent.trim().split(/\s+/).map(c=>{
        const [lon,lat] = c.split(",").map(parseFloat);
        return [lat,lon];
      }).filter(Boolean);
      if(coords.length>3) coordsList.push(coords);
    });
    if(coordsList.length>0){
      polygonsData.push({fid,name,category,coordsList});
    }
  });
}

function drawMap(sustained=0,gust=0){
  g.selectAll("*").remove();
  const transform = d3.geoTransform({
    point: function(x,y){
      const p = map.latLngToLayerPoint(new L.LatLng(y,x));
      this.stream.point(p.x,p.y);
    }
  });
  const pathGen = d3.geoPath().projection(transform);
  const selectedException = document.getElementById("localized-gusts-select").value;

  polygonsData.forEach(d=>{
    const cfg = WARNING_CONFIG[d.category];
    const isSpecial = "parentCategory" in cfg;
    const parentCat = isSpecial ? cfg.parentCategory : d.category;
    const parentConfig = WARNING_CONFIG[parentCat];
    
    // Determine the tier based on sustained/gust for a given config
    const getTier = (config) => {
      const t = config.thresholds;
      if (sustained >= t.RED.sustained || gust >= t.RED.gust) return TIERS.RED;
      if (sustained >= t.ORANGE.sustained || gust >= t.ORANGE.gust) return TIERS.ORANGE;
      if (sustained >= t.YELLOW.sustained || gust >= t.YELLOW.gust) return TIERS.YELLOW;
      return TIERS.NONE;
    };
    
    let fillTier = TIERS.NONE;
    let tooltipNote = '';
    
    // Logic for coloring based on the dropdown selection
    switch(selectedException) {
      case 'wreckhouse':
        if (d.category === 'Wreckhouse') {
          fillTier = getTier(cfg);
        } else {
          fillTier = TIERS.NONE;
        }
        break;
      case 'downslope-flow':
        if (d.category === 'Downslope NL') {
          fillTier = getTier(cfg);
        } else {
          fillTier = TIERS.NONE;
        }
        break;
      case 'les-suetes':
        if (d.category === 'Les Suetes') {
          fillTier = getTier(cfg);
        } else {
          fillTier = TIERS.NONE;
        }
        break;
      case 'exposed-areas':
        // This handles localized gusts for Landlocked NF
        if (d.category.includes('Landlocked')) {
            if (d.category === 'Landlocked NF' && gust === 90) {
                 fillTier = TIERS.NONE;
                 tooltipNote = '"Over exposed areas" exception used - therefore no warning is necessary. Use your discretion.';
            } else if (d.category === 'Landlocked NF' && gust === 110) {
                 fillTier = TIERS.YELLOW;
                 tooltipNote = '"Over exposed areas" exception used - issue a <span class="tooltip-tier yellow">YELLOW</span> warning.';
            } else if (d.category === 'Landlocked NF' && gust === 130) {
                 fillTier = TIERS.ORANGE;
                 tooltipNote = '"Over exposed areas" exception used - issue an <span class="tooltip-tier orange">ORANGE</span> warning.';
            } else if (d.category === 'Landlocked Labrador' && gust === 100) {
                 fillTier = TIERS.YELLOW;
                 tooltipNote = '"Over exposed areas" exception used - issue a <span class="tooltip-tier yellow">YELLOW</span> warning.';
            } else if (d.category === 'Landlocked Labrador' && gust === 110) {
                 fillTier = TIERS.ORANGE;
                 tooltipNote = '"Over exposed areas" exception used - issue an <span class="tooltip-tier orange">ORANGE</span> warning.';
            } else {
                 fillTier = getTier(parentConfig);
            }
        } else {
            fillTier = getTier(parentConfig);
        }
        break;
      case 'exposed-coast':
        if (d.category.includes('Landlocked')) {
            fillTier = TIERS.NONE;
            tooltipNote = "No Coastal Areas - No Warning";
        } else if (parentCat === 'Maritimes' || d.category === 'Maritimes' || d.category === 'Coastal NL') {
            if (gust === 110) {
                 fillTier = TIERS.YELLOW;
                 tooltipNote = '"Along exposed areas of the coast" exception used - issue a <span class="tooltip-tier yellow">YELLOW</span> warning.';
            } else if (gust === 130 || gust === 140) {
                 fillTier = TIERS.ORANGE;
                 tooltipNote = '"Along exposed areas of the coast" exception used - issue an <span class="tooltip-tier orange">ORANGE</span> warning.';
            } else {
                 fillTier = getTier(parentConfig);
            }
        } else {
            fillTier = getTier(parentConfig);
        }
        break;
      case 'parts-coast':
      case 'the-coast':
        if (d.category.includes('Landlocked')) {
            fillTier = TIERS.NONE;
            tooltipNote = "No Coastal Areas - No Warning";
        } else {
            fillTier = getTier(parentConfig);
        }
        break;
      default:
        // Default behavior (no exception selected)
        const specialTier = isSpecial ? getTier(cfg) : TIERS.NONE;
        const parentTier = getTier(parentConfig);
        fillTier = parentTier.level > specialTier.level ? parentTier : specialTier;
        break;
    }

    d.coordsList.forEach(polygon=>{
      const geo = {type:"Polygon",coordinates:[polygon.map(([lat,lon])=>[lon,lat])]};
      const pathD = pathGen(geo);

      g.append("path")
        .attr("d", pathD)
        .attr("fill", fillTier.color)
        .attr("fill-opacity", fillTier.level > 0 ? 0.4 : 0) // No fill opacity for 'NONE'
        .attr("stroke", "black")
        .attr("stroke-width", 1)
        .style("pointer-events", "all")
        .on("mousemove", event => {
          let tierName = fillTier.name;
          let thresholdsText = "";
          let tooltipHtml = `<b>${d.name}</b><br>`;
          
          if (tooltipNote) {
             tooltipHtml += `<hr><div class="text-xs italic text-gray-600">${tooltipNote}</div>`;
          } else if (tierName !== 'NONE') {
              const configSource = WARNING_CONFIG[d.category];
              const t = configSource.thresholds[tierName];
              if (t) {
                  thresholdsText = `Sustained ≥ ${t.sustained}, Gust ≥ ${t.gust} km/h`;
              }
              tooltipHtml += `Tier: <span class="tooltip-tier ${tierName.toLowerCase()}">${tierName}</span><br><span class="text-xs">${thresholdsText}</span>`;
          } else {
            tooltipHtml += 'No Warning';
          }

          tooltip
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY + 10) + "px")
            .style("opacity", 1)
            .html(tooltipHtml);
        })
        .on("mouseout", () => tooltip.style("opacity",0));
    });
  });
}

async function loadGML(){
  try{
    const resp = await fetch("land_standard_exaggerated_atlantic.gml");
    const text = await resp.text();
    parseGML(text);
    drawMap();
  }catch(e){ console.error(e); }
}

function updateOnPanZoom() {
    drawMap(
        parseFloat(document.getElementById("sustained-wind-input").value) || 0,
        parseFloat(document.getElementById("gust-wind-input").value) || 0
    );
}

map.on("zoomend moveend", updateOnPanZoom);

const sustainedInput = document.getElementById("sustained-wind-input");
const gustInput = document.getElementById("gust-wind-input");
const localizedGustsSelect = document.getElementById("localized-gusts-select");

const rounder = (inputEl) => {
    if (inputEl.value) {
        const roundedValue = Math.round(parseFloat(inputEl.value) / 10) * 10;
        inputEl.value = roundedValue;
    }
};

sustainedInput.addEventListener("change", () => rounder(sustainedInput));
gustInput.addEventListener("change", () => rounder(gustInput));
sustainedInput.addEventListener("input", updateOnPanZoom);
gustInput.addEventListener("input", updateOnPanZoom);
localizedGustsSelect.addEventListener("change", updateOnPanZoom);

loadGML();
</script>
</body>
</html>
